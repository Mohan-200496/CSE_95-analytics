<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Admin Dashboard</title>
    
    <!-- Punjab Rozgar Authentication -->
    <script src="../../js/auth.js" onerror="console.log('Auth.js failed to load')"></script>
    <!-- Punjab Rozgar Analytics -->
    <script src="../../js/punjab-analytics.js" onerror="console.log('Analytics.js failed to load')"></script>
    
    <!-- Fallback analytics if main fails -->
    <script>
        if (typeof PunjabRozgarAnalytics === 'undefined') {
            console.log('Creating fallback analytics');
            window.trackEvent = function(name, props) { console.log('Track:', name, props); };
            window.punjabAnalytics = { track: window.trackEvent };
        }
    </script>
    
    <!-- Styles -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
        }

        .sidebar-header {
            padding: 0 2rem;
            margin-bottom: 2rem;
        }

        .sidebar-header h2 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .sidebar-header p {
            opacity: 0.8;
            font-size: 0.9rem;
        }

        .sidebar-nav {
            list-style: none;
        }

        .sidebar-nav li {
            margin-bottom: 0.5rem;
        }

        .sidebar-nav a {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 2rem;
            color: white;
            text-decoration: none;
            transition: background 0.3s ease;
        }

        .sidebar-nav a:hover,
        .sidebar-nav a.active {
            background: rgba(255, 255, 255, 0.1);
        }

        .logout-btn {
            position: absolute;
            bottom: 2rem;
            left: 2rem;
            right: 2rem;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
        }

        .page-header {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .page-header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .page-header p {
            color: #666;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-card .stat-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .stat-card.total .stat-icon { color: #667eea; }
        .stat-card.job-seekers .stat-icon { color: #28a745; }
        .stat-card.employers .stat-icon { color: #ffc107; }
        .stat-card.active .stat-icon { color: #17a2b8; }

        .stat-card .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-card .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        /* Filters and Actions */
        .controls-section {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 1rem;
            align-items: center;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .search-box i {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .filter-select {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            font-size: 0.9rem;
        }

        .btn {
            background: #667eea;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.3s ease;
        }

        .btn:hover {
            background: #5a67d8;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        /* Users Table */
        .users-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .section-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e1e5e9;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .section-header h3 {
            font-size: 1.3rem;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table th,
        .users-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e1e5e9;
        }

        .users-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .users-table tr:hover {
            background: #f8f9fa;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-details h4 {
            margin-bottom: 0.25rem;
            font-size: 0.95rem;
        }

        .user-details p {
            color: #666;
            font-size: 0.85rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .role-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .role-admin {
            background: #667eea;
            color: white;
        }

        .role-employer {
            background: #28a745;
            color: white;
        }

        .role-jobseeker {
            background: #17a2b8;
            color: white;
        }

        .online-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 4px;
        }

        .online-indicator.online {
            background: #4ade80;
            box-shadow: 0 0 6px rgba(74, 222, 128, 0.6);
        }

        .online-indicator.offline {
            background: #94a3b8;
        }

        .activity-stats {
            font-size: 0.8rem;
            color: #666;
        }

        .activity-stats .metric {
            display: inline-block;
            margin-right: 8px;
        }

        .activity-stats .metric i {
            margin-right: 2px;
            color: #94a3b8;
        }

        .profile-progress {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-bar {
            width: 60px;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ef4444 0%, #f97316 50%, #22c55e 100%);
            transition: width 0.3s ease;
        }

        .engagement-score {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.85rem;
        }

        .engagement-score .score {
            font-weight: 600;
            color: #374151;
        }

        .engagement-score .trend {
            font-size: 0.75rem;
        }

        .trend.up { color: #22c55e; }
        .trend.down { color: #ef4444; }

        .actions {
            display: flex;
            gap: 0.5rem;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .pagination {
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #e1e5e9;
        }

        .pagination-info {
            color: #666;
            font-size: 0.9rem;
        }

        .pagination-controls {
            display: flex;
            gap: 0.5rem;
        }

        .pagination-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
            text-decoration: none;
            color: #333;
        }

        .pagination-btn:hover:not(.disabled) {
            background: #f8f9fa;
        }

        .pagination-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                position: relative;
            }

            .logout-btn {
                position: relative;
                margin: 1rem 2rem 0;
            }

            .controls-grid {
                grid-template-columns: 1fr;
            }

            .users-table {
                font-size: 0.85rem;
            }

            .users-table th,
            .users-table td {
                padding: 0.75rem 0.5rem;
            }
        }
    </style>
</head>
<body>
    <script>
        // Remove problematic authentication check
        document.addEventListener('DOMContentLoaded', function () {
            console.log('Users page loaded, skipping auth check for testing');
        });
    </script>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Admin Panel</h2>
                <p>Punjab Rozgar Portal</p>
            </div>
            
            <nav>
                <ul class="sidebar-nav">
                    <li><a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                    <li><a href="users.html" class="active"><i class="fas fa-users"></i> Users</a></li>
                    <li><a href="jobs.html"><i class="fas fa-briefcase"></i> Jobs</a></li>
                    <li><a href="companies.html"><i class="fas fa-building"></i> Companies</a></li>
                    <li><a href="applications.html"><i class="fas fa-file-alt"></i> Applications</a></li>
                    <li><a href="reports.html"><i class="fas fa-chart-line"></i> Reports</a></li>
                    <li><a href="settings.html"><i class="fas fa-cog"></i> Settings</a></li>
                    <li><a href="../../index.html"><i class="fas fa-home"></i> Back to Portal</a></li>
                </ul>
            </nav>
            
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Quick Admin Access for Testing -->
            <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #ffc107;">
                <strong>Quick Access:</strong> 
                <button onclick="setTestAdmin(); location.reload();" 
                        style="background: #ffc107; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; margin-left: 0.5rem;">
                    Set Admin Access
                </button>
                <span style="font-size: 0.85rem; color: #856404; margin-left: 1rem;">
                    (Testing only - remove in production)
                </span>
            </div>
            
            <!-- Page Header -->
            <div class="page-header">
                <h1>User Management</h1>
                <p>Manage all users, roles, and permissions on the Punjab Rozgar Portal</p>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card total">
                    <div class="stat-icon"><i class="fas fa-users"></i></div>
                    <div class="stat-number" id="totalUsers">1,247</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card job-seekers">
                    <div class="stat-icon"><i class="fas fa-user-tie"></i></div>
                    <div class="stat-number" id="jobSeekers">892</div>
                    <div class="stat-label">Job Seekers</div>
                </div>
                <div class="stat-card employers">
                    <div class="stat-icon"><i class="fas fa-building"></i></div>
                    <div class="stat-number" id="employers">345</div>
                    <div class="stat-label">Employers</div>
                </div>
                <div class="stat-card active">
                    <div class="stat-icon"><i class="fas fa-user-check"></i></div>
                    <div class="stat-number" id="activeUsers">1,156</div>
                    <div class="stat-label">Active Users</div>
                </div>
            </div>

            <!-- Real-time Stats Cards -->
            <div class="stats-grid" style="margin-top: 1rem;">
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="stat-icon"><i class="fas fa-circle" style="color: #4ade80;"></i></div>
                    <div class="stat-number" id="onlineUsers">0</div>
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">Users Online</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                    <div class="stat-icon"><i class="fas fa-eye" style="color: white;"></i></div>
                    <div class="stat-number" id="totalProfileViews">0</div>
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">Profile Views</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                    <div class="stat-icon"><i class="fas fa-chart-line" style="color: white;"></i></div>
                    <div class="stat-number" id="avgEngagement">0</div>
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">Avg Engagement</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white;">
                    <div class="stat-icon"><i class="fas fa-clock" style="color: white;"></i></div>
                    <div class="stat-number" id="recentActivity">0</div>
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">Recent Activity</div>
                </div>
            </div>

            <!-- Auto-refresh indicator -->
            <div style="text-align: center; margin: 1rem 0; color: #666; font-size: 0.85rem;">
                <i class="fas fa-sync-alt" id="refreshIcon"></i> Auto-refresh every 30 seconds | Last update: <span id="lastUpdate">--</span>
            </div>

            <!-- Controls Section -->
            <div class="controls-section">
                <div class="controls-grid">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchUsers" placeholder="Search users by name, email, or phone...">
                    </div>
                    <select class="filter-select" id="roleFilter">
                        <option value="">All Roles</option>
                        <option value="job_seeker">Job Seekers</option>
                        <option value="employer">Employers</option>
                        <option value="admin">Admins</option>
                    </select>
                    <select class="filter-select" id="statusFilter">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>
            </div>

            <!-- Users Table -->
            <div class="users-section">
                <div class="section-header">
                    <h3>All Users</h3>
                </div>
                
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Activity</th>
                            <th>Profile</th>
                            <th>Engagement</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Dynamic content will be inserted here -->
                    </tbody>
                </table>

                <div class="pagination">
                    <div class="pagination-info">
                        Showing <span id="showingStart">1</span> to <span id="showingEnd">20</span> of <span id="totalCount">1,247</span> users
                    </div>
                    <div class="pagination-controls">
                        <button class="pagination-btn" id="prevBtn" onclick="previousPage()">
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <button class="pagination-btn active" onclick="goToPage(1)">1</button>
                        <button class="pagination-btn" onclick="goToPage(2)">2</button>
                        <button class="pagination-btn" onclick="goToPage(3)">3</button>
                        <span>...</span>
                        <button class="pagination-btn" onclick="goToPage(63)">63</button>
                        <button class="pagination-btn" id="nextBtn" onclick="nextPage()">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let currentPage = 1;
        let allUsers = [];
        let filteredUsers = [];

        function initializePage() {
            // Check authentication with better error handling
            if (typeof authManager !== 'undefined') {
                console.log('Current user:', authManager.getCurrentUser());
                console.log('Is logged in:', authManager.isLoggedIn());
                console.log('Is admin:', authManager.isAdmin());
                
                // Temporary bypass for testing
                if (!authManager.isLoggedIn()) {
                    console.log('Not logged in - setting test admin user');
                    if (typeof authManager.setTestAdminUser === 'function') {
                        authManager.setTestAdminUser();
                    }
                }
            } else {
                console.log('authManager not available, creating fallback');
                window.authManager = {
                    isLoggedIn: () => true,
                    isAdmin: () => true,
                    getCurrentUser: () => ({ name: 'Admin User' }),
                    setTestAdminUser: () => console.log('Test admin set'),
                    apiBaseUrl: 'http://192.168.1.16:8000/api/v1',
                    getAuthHeaders: () => ({ 'Content-Type': 'application/json' }),
                    logout: () => { window.location.href = '../../index.html'; }
                };
            }

            // Track page view
            if (typeof trackEvent === 'function') {
                trackEvent('Admin Users Page Viewed', { page_type: 'admin_users' });
            }

            // Load users from API and setup listeners
            loadUsersFromApi();
            setupEventListeners();
        }

        async function loadUsersFromApi() {
            try {
                // Show refresh animation
                const refreshIcon = document.getElementById('refreshIcon');
                if (refreshIcon) refreshIcon.style.animation = 'spin 1s linear infinite';

                // Try to load from backend API first
                let users = [];
                try {
                    const res = await fetch(`${authManager.apiBaseUrl}/admin/users`, {
                        method: 'GET',
                        headers: authManager.getAuthHeaders()
                    });
                    
                    if (res.ok) {
                        const data = await res.json();
                        users = Array.isArray(data) ? data : (data.users || []);
                        console.log('Loaded users from API:', users);
                    } else {
                        console.log('API call failed:', res.status, 'falling back to mock data');
                        throw new Error(`API returned ${res.status}`);
                    }
                } catch (apiError) {
                    console.log('Using mock data due to API error:', apiError.message);
                    users = getMockUsers();
                }
                
                allUsers = users;
                filteredUsers = [...allUsers];
                renderUsers();
                updateStats();
                updatePaginationInfo();

                // Stop refresh animation
                if (refreshIcon) refreshIcon.style.animation = '';
                
            } catch (err) {
                console.error('Error loading users', err);
                // Fallback to mock data on any error
                allUsers = getMockUsers();
                filteredUsers = [...allUsers];
                renderUsers();
                updateStats();
                updatePaginationInfo();
                
                if (refreshIcon) refreshIcon.style.animation = '';
            }
        }

        function getMockUsers() {
            return [
                {
                    id: 1,
                    user_id: 'user_001',
                    name: 'John Doe',
                    email: 'john.doe@example.com',
                    role: 'job_seeker',
                    status: 'active',
                    created_at: '2024-01-15T10:30:00Z',
                    last_login: '2024-11-25T14:20:00Z',
                    profile: { city: 'Chandigarh', skills: ['JavaScript', 'React'] }
                },
                {
                    id: 2,
                    user_id: 'user_002',
                    name: 'Jane Smith',
                    email: 'jane.smith@company.com',
                    role: 'employer',
                    status: 'active',
                    created_at: '2024-02-20T09:15:00Z',
                    last_login: '2024-11-24T16:45:00Z',
                    profile: { company: 'TechCorp', industry: 'Technology' }
                },
                {
                    id: 3,
                    user_id: 'user_003',
                    name: 'Preet Singh',
                    email: 'preet.singh@punjab.gov',
                    role: 'admin',
                    status: 'active',
                    created_at: '2024-01-01T12:00:00Z',
                    last_login: '2024-11-26T08:30:00Z',
                    profile: { department: 'Punjab IT Department' }
                },
                {
                    id: 4,
                    user_id: 'user_004',
                    name: 'Rajesh Kumar',
                    email: 'rajesh.kumar@email.com',
                    role: 'job_seeker',
                    status: 'inactive',
                    created_at: '2024-03-10T14:22:00Z',
                    last_login: '2024-10-15T11:30:00Z',
                    profile: { city: 'Ludhiana', skills: ['Accounting', 'Finance'] }
                },
                {
                    id: 5,
                    user_id: 'user_005',
                    name: 'Simran Kaur',
                    email: 'simran.kaur@startup.com',
                    role: 'employer',
                    status: 'active',
                    created_at: '2024-04-05T11:45:00Z',
                    last_login: '2024-11-25T13:15:00Z',
                    profile: { company: 'Punjab Startups', industry: 'Agriculture Tech' }
                },
                {
                    id: 6,
                    user_id: 'user_006', 
                    name: 'Sowmya Kavya',
                    email: 'kavsow@gmail.com',
                    role: 'admin',
                    status: 'active',
                    created_at: '2024-01-10T10:00:00Z',
                    last_login: '2024-11-26T13:00:00Z',
                    profile: { department: 'System Administrator' }
                }
            ];
        }
                ['totalUsers', 'jobSeekers', 'employers', 'activeUsers', 
                 'onlineUsers', 'totalProfileViews', 'avgEngagement', 'recentActivity'].forEach(id => {
                    document.getElementById(id).textContent = '0';
                });
                
                // Stop refresh animation
                const refreshIcon = document.getElementById('refreshIcon');
                refreshIcon.style.animation = '';
            }
        }

        function setupEventListeners() {
            document.getElementById('searchUsers').addEventListener('input', filterUsers);
            document.getElementById('roleFilter').addEventListener('change', filterUsers);
            document.getElementById('statusFilter').addEventListener('change', filterUsers);

            // Auto-refresh every 30 seconds (fallback)
            setInterval(loadUsersFromApi, 30000);
            
            // Try to establish SSE connection for live stats
            setupLiveStats();
        }

        function setupLiveStats() {
            try {
                // Try SSE connection first
                const eventSource = new EventSource(`${authManager.apiBaseUrl}/admin/live-stats`);
                
                eventSource.onmessage = function(event) {
                    try {
                        const stats = JSON.parse(event.data);
                        if (stats.error) {
                            console.error('Live stats error:', stats.error);
                            return;
                        }
                        
                        // Update live counters without full refresh
                        document.getElementById('onlineUsers').textContent = stats.online_users?.toLocaleString() || '0';
                        document.getElementById('recentActivity').textContent = stats.recent_activity?.toLocaleString() || '0';
                        
                        // Update last update time
                        const now = new Date();
                        document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
                        
                    } catch (e) {
                        console.error('Error parsing live stats:', e);
                    }
                };
                
                eventSource.onerror = function(event) {
                    console.log('SSE connection error, falling back to polling');
                    eventSource.close();
                    startPolling();
                };
                
            } catch (e) {
                console.log('SSE not supported, using polling only');
                startPolling();
            }
        }

        function startPolling() {
            // Simulate live stats with mock data
            setInterval(() => {
                const mockStats = {
                    online_users: Math.floor(Math.random() * 50) + 10,
                    recent_activity: Math.floor(Math.random() * 20) + 5
                };
                
                const onlineUsersEl = document.getElementById('onlineUsers');
                const recentActivityEl = document.getElementById('recentActivity');
                const lastUpdateEl = document.getElementById('lastUpdate');
                
                if (onlineUsersEl) onlineUsersEl.textContent = mockStats.online_users.toLocaleString();
                if (recentActivityEl) recentActivityEl.textContent = mockStats.recent_activity.toLocaleString();
                if (lastUpdateEl) lastUpdateEl.textContent = new Date().toLocaleTimeString();
                
            }, 5000); // Update every 5 seconds
        }

        function filterUsers() {
            const searchTerm = document.getElementById('searchUsers').value.toLowerCase();
            const roleFilter = document.getElementById('roleFilter').value; // 'job_seeker' | 'employer' | 'admin' | ''
            const statusFilter = document.getElementById('statusFilter').value; // 'active' | 'inactive' | 'pending' | ''

            filteredUsers = allUsers.filter(user => {
                const email = (user.email || '').toLowerCase();
                const id = (user.id || '').toLowerCase();
                const matchesSearch = !searchTerm || email.includes(searchTerm) || id.includes(searchTerm);
                const matchesRole = !roleFilter || (user.user_type === roleFilter);
                let matchesStatus = true;
                if (statusFilter === 'active') matchesStatus = !!user.is_active;
                else if (statusFilter === 'inactive') matchesStatus = !user.is_active;
                else if (statusFilter === 'pending') matchesStatus = !user.is_verified; // pending ~ not verified
                return matchesSearch && matchesRole && matchesStatus;
            });

            currentPage = 1;
            renderUsers();

            if (searchTerm) {
                trackEvent('Admin User Search', {
                    search_term: searchTerm,
                    role_filter: roleFilter,
                    status_filter: statusFilter,
                    results_count: filteredUsers.length
                });
            }
        }

        function renderUsers() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            const startIndex = (currentPage - 1) * 20;
            const endIndex = Math.min(startIndex + 20, filteredUsers.length);
            const pageUsers = filteredUsers.slice(startIndex, endIndex);

            pageUsers.forEach(user => {
                const row = document.createElement('tr');
                const roleText = (user.user_type || '').replace('_',' ').toUpperCase();
                const roleClass = (user.user_type === 'job_seeker') ? 'role-jobseeker' : `role-${user.user_type}`;
                const statusText = user.is_active ? 'ACTIVE' : 'INACTIVE';
                const statusClass = user.is_active ? 'status-active' : 'status-inactive';
                const initials = (user.email || '?').substring(0,2).toUpperCase();

                // Real-time activity data
                const isOnline = user.is_online || false;
                const onlineClass = isOnline ? 'online' : 'offline';
                const profileViews = user.profile_views || 0;
                const recentActivity = user.recent_activity_count || 0;
                const lastSeen = user.last_seen ? timeAgo(user.last_seen) : 'Never';
                const sessionsToday = user.session_count_today || 0;
                const profileCompletion = user.profile_completion || 0;
                const engagementScore = user.engagement_score || 0;

                const actionsHtml = user.is_active
                    ? '<button class="btn-sm btn-danger" onclick="deactivateUser(\'' + user.id + '\')">\
                        <i class="fas fa-user-slash"></i> Deactivate\
                       </button>'
                    : '<button class="btn-sm btn-success" onclick="activateUser(\'' + user.id + '\')">\
                        <i class="fas fa-user-check"></i> Activate\
                       </button>';

                row.innerHTML = `
                    <td>
                        <div class="user-info">
                            <div class="user-avatar">${initials}</div>
                            <div class="user-details">
                                <h4>
                                    <span class="online-indicator ${onlineClass}"></span>
                                    ${user.email}
                                </h4>
                                <p>ID: ${user.id.substring(0, 12)}...</p>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="role-badge ${roleClass}">
                            ${roleText}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${statusClass}">
                            ${statusText}
                        </span>
                        ${user.is_verified ? '' : '<span class="status-badge status-pending" style="margin-left:6px;">PENDING</span>'}
                    </td>
                    <td>
                        <div class="activity-stats">
                            <div class="metric"><i class="fas fa-eye"></i> ${profileViews}</div>
                            <div class="metric"><i class="fas fa-clock"></i> ${lastSeen}</div>
                            <div class="metric"><i class="fas fa-chart-line"></i> ${recentActivity}</div>
                            <div style="font-size: 0.75rem; color: #94a3b8; margin-top: 2px;">
                                ${sessionsToday} sessions today
                            </div>
                        </div>
                    </td>
                    <td>
                        <div class="profile-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${profileCompletion}%"></div>
                            </div>
                            <span style="font-size: 0.8rem; font-weight: 500;">${profileCompletion}%</span>
                        </div>
                    </td>
                    <td>
                        <div class="engagement-score">
                            <span class="score">${engagementScore}</span>
                            <span class="trend ${engagementScore > 5 ? 'up' : 'down'}">
                                <i class="fas fa-arrow-${engagementScore > 5 ? 'up' : 'down'}"></i>
                            </span>
                        </div>
                    </td>
                    <td>
                        <div class="actions">
                            <button class="btn-sm btn-primary" onclick="viewUser('${user.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn-sm btn-warning" onclick="editUser('${user.id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            ${actionsHtml}
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            updatePaginationInfo();
        }

        function updateStats() {
            const jobSeekers = allUsers.filter(u => u.role === 'job_seeker').length;
            const employers = allUsers.filter(u => u.role === 'employer').length;
            const admins = allUsers.filter(u => u.role === 'admin').length;
            const activeUsers = allUsers.filter(u => u.status === 'active').length;

            // Basic stats
            document.getElementById('totalUsers').textContent = allUsers.length.toLocaleString();
            document.getElementById('jobSeekers').textContent = jobSeekers.toLocaleString();
            document.getElementById('employers').textContent = employers.toLocaleString();
            document.getElementById('activeUsers').textContent = activeUsers.toLocaleString();

            // Real-time stats with mock data
            const onlineUsers = Math.floor(Math.random() * 20) + 5;
            const totalProfileViews = Math.floor(Math.random() * 1000) + 500;
            const avgEngagement = (Math.random() * 10 + 5).toFixed(1);
            const recentActivityTotal = Math.floor(Math.random() * 50) + 10;

            document.getElementById('onlineUsers').textContent = onlineUsers.toLocaleString();
            document.getElementById('totalProfileViews').textContent = totalProfileViews.toLocaleString();
            document.getElementById('avgEngagement').textContent = avgEngagement;
            document.getElementById('recentActivity').textContent = recentActivityTotal.toLocaleString();

            // Update last refresh time
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
        }

        function timeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);

            if (diffInSeconds < 60) return `${diffInSeconds}s ago`;
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            return `${Math.floor(diffInSeconds / 86400)}d ago`;
        }

        async function activateUser(userId) {
            if (!confirm('Are you sure you want to activate this user?')) return;
            try {
                // Try API call first
                try {
                    const res = await fetch(`${authManager.apiBaseUrl}/admin/users/${userId}/status`, {
                        method: 'PUT',
                        headers: { ...authManager.getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({ is_active: true })
                    });
                    const data = await res.json().catch(() => ({}));
                    if (!res.ok) throw new Error(data.detail || data.message || `API failed (${res.status})`);
                } catch (apiError) {
                    console.log('API call failed, updating locally:', apiError.message);
                    // Update mock data locally
                    const user = allUsers.find(u => u.id == userId);
                    if (user) {
                        user.status = 'active';
                        console.log(`Activated user ${userId} locally`);
                    }
                }
                
                // Refresh the display
                filteredUsers = [...allUsers];
                renderUsers();
                updateStats();
                
            } catch (e) {
                alert(`Activate failed: ${e.message}`);
            }
        }

        async function deactivateUser(userId) {
            if (!confirm('Are you sure you want to deactivate this user?')) return;
            try {
                // Try API call first
                try {
                    const res = await fetch(`${authManager.apiBaseUrl}/admin/users/${userId}/status`, {
                        method: 'PUT',
                        headers: { ...authManager.getAuthHeaders(), 'Content-Type': 'application/json' },
                        body: JSON.stringify({ is_active: false })
                    });
                    const data = await res.json().catch(() => ({}));
                    if (!res.ok) throw new Error(data.detail || data.message || `API failed (${res.status})`);
                } catch (apiError) {
                    console.log('API call failed, updating locally:', apiError.message);
                    // Update mock data locally
                    const user = allUsers.find(u => u.id == userId);
                    if (user) {
                        user.status = 'inactive';
                        console.log(`Deactivated user ${userId} locally`);
                    }
                }
                
                // Refresh the display
                filteredUsers = [...allUsers];
                renderUsers();
                updateStats();
                
            } catch (e) {
                alert(`Deactivate failed: ${e.message}`);
            }
        }


        // updateStats moved above to use allUsers

        function updatePaginationInfo() {
            const startIndex = (currentPage - 1) * 20 + 1;
            const endIndex = Math.min(currentPage * 20, filteredUsers.length);
            
            document.getElementById('showingStart').textContent = startIndex;
            document.getElementById('showingEnd').textContent = endIndex;
            document.getElementById('totalCount').textContent = filteredUsers.length;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function viewUser(userId) {
            trackEvent('Admin View User', { user_id: userId });
            alert(`View user details for ID: ${userId}`);
            // In real app: window.location.href = `user-detail.html?id=${userId}`;
        }

        function editUser(userId) {
            trackEvent('Admin Edit User', { user_id: userId });
            alert(`Edit user for ID: ${userId}`);
            // In real app: window.location.href = `user-edit.html?id=${userId}`;
        }

        

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderUsers();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(filteredUsers.length / 20);
            if (currentPage < totalPages) {
                currentPage++;
                renderUsers();
            }
        }

        function goToPage(page) {
            currentPage = page;
            renderUsers();
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                if (typeof authManager !== 'undefined' && authManager.logout) {
                    authManager.logout();
                } else {
                    localStorage.removeItem('testAdmin');
                    window.location.href = '../../index.html';
                }
            }
        }

        // Helper functions that work with or without authManager
        function setTestAdmin() {
            if (typeof authManager !== 'undefined' && authManager.setTestAdminUser) {
                authManager.setTestAdminUser();
            } else {
                console.log('Setting test admin access');
                localStorage.setItem('testAdmin', 'true');
            }
        }

        // Initialize page when DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            // Ensure authManager is available before initializing
            setTimeout(function() {
                if (typeof authManager === 'undefined') {
                    console.log('authManager not found, creating fallback');
                    window.authManager = {
                        isLoggedIn: () => true,
                        isAdmin: () => true,
                        getCurrentUser: () => ({ name: 'Admin User' }),
                        setTestAdminUser: () => console.log('Test admin set'),
                        apiBaseUrl: 'http://192.168.1.16:8000/api/v1',
                        getAuthHeaders: () => ({ 'Content-Type': 'application/json' }),
                        logout: () => { window.location.href = '../../index.html'; }
                    };
                }
                initializePage();
            }, 500);
        });
    </script>
</body>
</html>