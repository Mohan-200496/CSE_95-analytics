<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Jobs - Punjab Rozgar Portal</title>
    <script src="../../js/auth.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: #f5f7fa; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 0; }
        .page-title { font-size: 2rem; margin-bottom: 10px; }
        .job-card { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin: 20px 0; padding: 20px; }
        .job-title { color: #333; font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; }
        .job-meta { color: #666; margin-bottom: 10px; }
        .job-status { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        .status-active { background: #d4edda; color: #155724; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 4px; margin: 20px 0; }
        .btn { background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        .empty-state { text-align: center; padding: 60px 20px; color: #666; }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 class="page-title">My Jobs</h1>
            <p>Manage your job postings</p>
        </div>
    </header>

    <div class="container">
        <div id="job-list">
            <div class="loading">
                <p>Loading your jobs...</p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Ensure user is logged in and is employer
            if (!authManager.requireRole('employer', '/pages/auth/login.html')) return;
            
            await loadMyJobs();
        });

        async function loadMyJobs() {
            const container = document.getElementById('job-list');
            
            try {
                console.log('=== LOADING MY JOBS ===');
                
                // Get token
                const token = authManager.getToken();
                if (!token) {
                    throw new Error('No authentication token found');
                }

                console.log('Token available:', !!token);
                console.log('Current user:', authManager.getCurrentUser());

                // Call API
                const response = await fetch('https://punjab-rozgar-api.onrender.com/api/v1/jobs/my-jobs', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('API Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }

                const jobs = await response.json();
                console.log('Jobs received:', jobs);

                // Display jobs
                if (Array.isArray(jobs) && jobs.length > 0) {
                    displayJobs(jobs);
                } else {
                    showEmptyState();
                }

            } catch (error) {
                console.error('Error loading jobs:', error);
                showError(error.message);
            }
        }

        function displayJobs(jobs) {
            const container = document.getElementById('job-list');
            
            const jobsHTML = jobs.map(job => `
                <div class="job-card">
                    <div class="job-title">${job.title}</div>
                    <div class="job-meta">
                        <span><strong>Location:</strong> ${job.location_city}, ${job.location_state}</span> | 
                        <span><strong>Type:</strong> ${job.job_type}</span> | 
                        <span><strong>Category:</strong> ${job.category}</span>
                    </div>
                    <div class="job-meta">
                        <span><strong>Created:</strong> ${new Date(job.created_at).toLocaleDateString()}</span>
                        ${job.salary_min ? `| <span><strong>Salary:</strong> ${job.salary_min} - ${job.salary_max} ${job.salary_currency || 'PKR'}</span>` : ''}
                    </div>
                    <div class="job-meta">
                        <span class="job-status status-${job.status}">${job.status.toUpperCase()}</span>
                        <span style="margin-left: 10px;"><strong>Job ID:</strong> ${job.job_id}</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <p>${job.description.substring(0, 200)}${job.description.length > 200 ? '...' : ''}</p>
                    </div>
                </div>
            `).join('');

            container.innerHTML = `
                <h3>Your Jobs (${jobs.length})</h3>
                ${jobsHTML}
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn" onclick="window.location.href='add-job.html'">Post New Job</button>
                    <button class="btn" onclick="loadMyJobs()" style="margin-left: 10px; background: #28a745;">Refresh</button>
                </div>
            `;
        }

        function showEmptyState() {
            const container = document.getElementById('job-list');
            container.innerHTML = `
                <div class="empty-state">
                    <h3>No Jobs Found</h3>
                    <p>You haven't posted any jobs yet.</p>
                    <button class="btn" onclick="window.location.href='add-job.html'">Post Your First Job</button>
                </div>
            `;
        }

        function showError(message) {
            const container = document.getElementById('job-list');
            container.innerHTML = `
                <div class="error">
                    <h4>Error Loading Jobs</h4>
                    <p>${message}</p>
                    <button class="btn" onclick="loadMyJobs()">Try Again</button>
                </div>
            `;
        }
    </script>
</body>
</html>