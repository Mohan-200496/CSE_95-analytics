#!/bin/bash

# Render PostgreSQL Setup Guide
# This script provides commands and guidance for setting up PostgreSQL on Render

echo "ğŸš€ Punjab Rozgar Portal - Render PostgreSQL Setup"
echo "=================================================="

echo ""
echo "ğŸ“‹ Pre-Setup Checklist:"
echo "âœ… Render account created"
echo "âœ… Frontend deployed on Render"
echo "âœ… Backend deployed on Render"
echo "â³ PostgreSQL database (this guide)"

echo ""
echo "ğŸ—„ï¸ Step 1: Create PostgreSQL Database"
echo "--------------------------------------"
echo "1. Go to: https://dashboard.render.com"
echo "2. Click 'New' â†’ 'PostgreSQL'"
echo "3. Configure:"
echo "   Name: punjab-rozgar-db"
echo "   Database: punjab_rozgar"
echo "   User: (auto-generated)"
echo "   Plan: Free (or preferred)"
echo "   Region: Same as backend service"

echo ""
echo "ğŸ”§ Step 2: Get Connection Details"
echo "---------------------------------"
echo "After database creation, copy from Render dashboard:"
echo "ğŸ“‹ Internal Database URL (recommended for backend)"
echo "ğŸ“‹ External Database URL (for external tools)"
echo "ğŸ“‹ Connection parameters (host, port, user, password, database)"

echo ""
echo "âš™ï¸ Step 3: Configure Backend Service"
echo "------------------------------------"
echo "In your backend service environment variables:"
echo "DATABASE_URL=postgresql://user:password@host:5432/database"
echo "SECRET_KEY=your-super-secret-key-here"
echo "ALGORITHM=HS256"
echo "ACCESS_TOKEN_EXPIRE_MINUTES=30"
echo "RENDER=true"
echo "DEBUG=false"
echo "ENVIRONMENT=production"

echo ""
echo "ğŸš€ Step 4: Deploy and Test"
echo "-------------------------"
echo "1. Push code changes to Git repository"
echo "2. Render auto-deploys backend"
echo "3. Monitor deployment logs"
echo "4. Test database connection"

echo ""
echo "âœ… Step 5: Verification Commands"
echo "-------------------------------"
echo "Test locally (optional):"
echo "export DATABASE_URL='postgresql://user:password@host:5432/database'"
echo "python health_check.py"
echo ""
echo "Test on Render:"
echo "Check service logs for 'Database connection successful'"

echo ""
echo "ğŸ” Common PostgreSQL Connection Formats:"
echo "---------------------------------------"
echo "Internal: postgresql://user:pass@host-internal:5432/db"
echo "External: postgresql://user:pass@host-external:5432/db"
echo "Async:    postgresql+asyncpg://user:pass@host:5432/db"

echo ""
echo "ğŸ“Š Database Features Enabled:"
echo "----------------------------"
echo "âœ… Persistent storage"
echo "âœ… Concurrent connections"
echo "âœ… Automatic backups"
echo "âœ… Analytics support"
echo "âœ… Full-text search"
echo "âœ… JSON columns"
echo "âœ… Advanced indexing"

echo ""
echo "ğŸ›¡ï¸ Security Best Practices:"
echo "---------------------------"
echo "âœ… Use Internal URLs for backend connections"
echo "âœ… Store credentials in environment variables"
echo "âœ… Enable SSL/TLS in production"
echo "âœ… Regular security updates"
echo "âœ… Monitor access logs"

echo ""
echo "ğŸ“ˆ Monitoring & Maintenance:"
echo "---------------------------"
echo "âœ… Check Render dashboard for database metrics"
echo "âœ… Monitor connection pool usage"
echo "âœ… Review slow query logs"
echo "âœ… Set up alerts for downtime"
echo "âœ… Regular backup verification"

echo ""
echo "ğŸ”§ Troubleshooting Tips:"
echo "-----------------------"
echo "âŒ Connection refused â†’ Check DATABASE_URL format"
echo "âŒ Auth failed â†’ Verify username/password"
echo "âŒ Database not found â†’ Check database name"
echo "âŒ SSL errors â†’ Add ?sslmode=require to URL"
echo "âŒ Pool exhausted â†’ Check connection limits"

echo ""
echo "ğŸ‰ Success Indicators:"
echo "--------------------"
echo "âœ… Backend logs show 'Database connection successful'"
echo "âœ… Health check endpoint returns 200"
echo "âœ… User registration works"
echo "âœ… Job posting persists data"
echo "âœ… No 500 errors in application"

echo ""
echo "ğŸ“š Useful Resources:"
echo "------------------"
echo "ğŸ“– Render PostgreSQL Docs: https://render.com/docs/databases"
echo "ğŸ“– SQLAlchemy AsyncPG: https://docs.sqlalchemy.org/en/14/dialects/postgresql.html#module-sqlalchemy.dialects.postgresql.asyncpg"
echo "ğŸ“– FastAPI Database: https://fastapi.tiangolo.com/tutorial/sql-databases/"

echo ""
echo "ğŸš€ Ready to proceed? Follow the steps above and then:"
echo "1. Run: python health_check.py"
echo "2. Test your application"
echo "3. Monitor for any issues"
echo ""
echo "Good luck with your deployment! ğŸ‰"